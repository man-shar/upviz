<!DOCTYPE html>
<link rel="stylesheet" type="text/css" href="viz.css">
<body onload="newmaps('17')">
	<div class="year_dropdown_container noselect">
		<select id="year_dropdown" name="select" onchange="makeviz(this)" data-old-value="17" data-first-run="true" autocomplete="off">
			<option value="17" >2017</option> 
			<option value="12">2012</option>
			<option value="07">2007</option>
		</select>
	</div>
	<div class="toviz">
	</div>
	<div class="position_toggle_container noselect">
		<p>
			<label>
				<input autocomplete="off" type="checkbox" id="winner_checkbox" class="checkbox" onclick="toggle(this)" value="won" checked="checked">
				Constituencies where the party won
			</label>
		</p>
		<p>
			<label>
				<input autocomplete="off" type="checkbox" id="runnerup_checkbox" class="checkbox" onclick="toggle(this)" value="runnerup" checked="checked">
				Constituencies where the party was the runner up
			</label>
		</p>
		<p>
			<label>
				<input autocomplete="off" type="checkbox" id="below_checkbox" class="checkbox" onclick="toggle(this)" value="third" checked="checked">
				Constituencies where the party was 3rd and Below
			</label>
		</p>
	</div>
</body>


<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script>

	var party_colors = {
    'INC': '#0392cf', // blue
    'BJP': '#feb24c', // orange
    'SP': '#bd0026', // red
    'BSP': '#7bc043', // green
    'IND': '#65737e'
}

function toggle(option){
	var tocheckornottocheck=(option.getAttribute("checked")=="unchecked")?"checked":"unchecked";
	option.setAttribute("checked",tocheckornottocheck);
	Array.from(document.getElementsByClassName(option.value)).forEach(function(element){
		element.classList.toggle("hidden");
	});
}
function makeviz(year){
	if (year.value=="07"){
		oldmaps(year.value);
	}
	else
	{
		newmaps(year.value);
	}
}


function newmaps(year){
	d3.json("uptoponew.json", function(error, up) {
		if (error) throw error;

		var geo_obj=topojson.feature(up,up.objects.up);

		var projection=d3.geoMercator()
		.fitSize([230,230],geo_obj);
		var path = d3.geoPath().projection(projection);

		var width=1250;
		var height=600;

		var g_turnout=d3.select(".turnout.toviz");
		var g_bjp=d3.select(".bjp.toviz");;
		var g_inc=d3.select(".inc.toviz");;
		var g_sp=d3.select(".sp.toviz");;
		var g_bsp=d3.select(".bsp.toviz");;

		var loss_scale=d3.scaleLinear()
		.domain([-230000,-88000])
		.range(["#333","#aaa"]);

		var tout_scale= d3.scaleQuantize()
		.domain([30,100])
		.range(['#fcfbfd','#efedf5','#dadaeb','#bcbddc','#9e9ac8','#807dba','#6a51a3','#54278f','#3f007d']);

		var bjp_col_scale= d3.scaleLinear()
		.domain([0,150000])
		.range(['#ffffff',party_colors["BJP"]]);

		var inc_col_scale= d3.scaleLinear()
		.domain([0,150000])
		.range(['#ffffff',party_colors["INC"]]);

		var bsp_col_scale= d3.scaleLinear()
		.domain([0,150000])
		.range(['#ffffff',party_colors["BSP"]]);

		var sp_col_scale= d3.scaleLinear()
		.domain([0,150000])
		.range(['#ffffff',party_colors["SP"]]);

		var previous=document.getElementById("year_dropdown").dataset.oldValue;
		document.getElementById("year_dropdown").dataset.oldValue=year;
		var svg=d3.select("#tout_chart_container");



		if(document.getElementById("year_dropdown").dataset.firstRun==="true" || previous==="07")
		{
			d3.select("#tout_chart_container").remove();
			svg = d3.select("body").append("svg").attr("width",width).attr("height",height).attr("id","tout_chart_container");
			g_turnout=svg.append("g").attr("width",250).attr("height",250).attr("class","turnout toviz").attr("transform","translate(0,0)");
			g_bjp=svg.append("g").attr("width",250).attr("height",250).attr("class","bjp toviz").attr("transform","translate(250,0)");
			g_inc=svg.append("g").attr("width",250).attr("height",250).attr("class","inc toviz").attr("transform","translate(500,0)");
			g_sp=svg.append("g").attr("width",250).attr("height",250).attr("class","sp toviz").attr("transform","translate(750,0)");
			g_bsp=svg.append("g").attr("width",250).attr("height",250).attr("class","bsp toviz").attr("transform","translate(1000,0)");

			g_turnout.selectAll("path")
			.data(geo_obj.features)
			.enter().append("path")
			.attr("d",path);

			g_bjp.selectAll("path")
			.data(geo_obj.features)
			.enter().append("path")    
			.attr("class",function(d){
				if (d.properties["W_P"+year]=="BJP") return "won";
				else if(d.properties["RU_P"+year]=="BJP") return "runnerup";
				else return "third";
			})
			.attr("d", path);

			g_inc.selectAll("path")
			.data(geo_obj.features)
			.enter().append("path")
			.attr("class",function(d){
				if (d.properties["W_P"+year]=="INC") 
					return "won";
				else if(d.properties["RU_P"+year]=="INC") 
					return "runnerup";
				else 
					return "third";
			})
			.attr("d", path);

			g_sp.selectAll("path")
			.data(geo_obj.features)
			.enter().append("path")
			.attr("class",function(d){
				if (d.properties["W_P"+year]=="SP") return "won";
				else if(d.properties["RU_P"+year]=="SP") return "runnerup";
				else return "third";
			})
			.attr("d", path);

			g_bsp.selectAll("path")
			.data(geo_obj.features)
			.enter().append("path")
			.attr("class",function(d){
				if (d.properties["W_P"+year]=="BSP") return "won";
				else if(d.properties["RU_P"+year]=="BSP") return "runnerup";
				else return "third";
			})
			.attr("d", path);

			document.getElementById("year_dropdown").dataset.firstRun="false";
		}

		var t = d3.transition()
		.duration(300)
		
		g_turnout.selectAll("path")
		.each(function(d,i){
			d3.select(this)
			.transition(t)
			.style("fill",function(d){
				return tout_scale(+d.properties["Turnout"+year]);
			});
		});

		g_bjp.selectAll("path").each(function(){
			d3.select(this).attr("class",function(d){
				if (d.properties["W_P"+year]=="BJP") return "won";
				else if(d.properties["RU_P"+year]=="BJP") return "runnerup";
				else return "third";
			})
			.transition(t)
			.style("fill",function(d){
				return +d.properties["BJP"+year]-(+d.properties["W_V"+year])==0?bjp_col_scale(+d.properties["BJP"+year]-(+d.properties["RU_V"+year])):loss_scale((+d.properties["BJP"+year]-(+d.properties["W_V"+year])));
			});
		});
		g_inc.selectAll("path").each(function(){
			d3.select(this).attr("class",function(d){
				if (d.properties["W_P"+year]=="INC") 
					return "won";
				else if(d.properties["RU_P"+year]=="INC") 
					return "runnerup";
				else 
					return "third";
			})
			.transition(t)
			.style("fill",function(d){
				return +d.properties["INC"+year]-(+d.properties["W_V"+year])==0?inc_col_scale(+d.properties["INC"+year]-(+d.properties["RU_V"+year])):loss_scale((+d.properties["INC"+year]-(+d.properties["W_V"+year])));
			});;
		});
		g_sp.selectAll("path").each(function(){
			d3.select(this).attr("class",function(d){
				if (d.properties["W_P"+year]=="SP") return "won";
				else if(d.properties["RU_P"+year]=="SP") return "runnerup";
				else return "third";
			})
			.transition(t)
			.style("fill",function(d){
				return +d.properties["SP"+year]-(+d.properties["W_V"+year])==0?sp_col_scale(+d.properties["SP"+year]-(+d.properties["RU_V"+year])):loss_scale((+d.properties["SP"+year]-(+d.properties["W_V"+year])));
			});
		});
		g_bsp.selectAll("path").each(function(){
			d3.select(this).attr("class",function(d){
				if (d.properties["W_P"+year]=="BSP") return "won";
				else if(d.properties["RU_P"+year]=="BSP") return "runnerup";
				else return "third";
			})
			.transition(t)
			.style("fill",function(d){
				return +d.properties["BSP"+year]-(+d.properties["W_V"+year])==0?bsp_col_scale(+d.properties["BSP"+year]-(+d.properties["RU_V"+year])):loss_scale((+d.properties["BSP"+year]-(+d.properties["W_V"+year])));
			});

		});
		

		var g_turnout=d3.select(".turnout.toviz");
		var g_bjp=d3.select(".bjp.toviz");
		var g_inc=d3.select(".inc.toviz");
		var g_sp=d3.select(".sp.toviz");
		var g_bsp=d3.select(".bsp.toviz");


		

		Array.from(document.getElementsByClassName("checkbox")).forEach(function(element){
			if(element.getAttribute("checked")=="unchecked")
			{
				element.classList.toggle("hidden");
			}
		});
	});



}

function oldmaps(year){

	d3.json("uptopoold.json", function(error, up) {

		if (error) throw error;

		var geo_obj=topojson.feature(up,up.objects.up);

		var projection=d3.geoMercator()
		.fitSize([230,230],geo_obj);
		var path = d3.geoPath().projection(projection);

		d3.select("#tout_chart_container").remove();
		var width=1250;
		var height=600;

		var t = d3.transition()
		.duration(300)
		;


		document.getElementById("year_dropdown").dataset.oldValue=year;

		var tout_scale= d3.scaleLinear()
		.domain([30,100])
		.range(['#b3cde3','#810f7c']);

		var col_scale= d3.scaleQuantize()
		.domain([10, 150000])
		.range(['#9ecae1','#6baed6','#4292c6','#2171b5','#084594']);
		var svg = d3.select("body").append("svg").attr("width",width).attr("height",height).attr("id","tout_chart_container");
		var g_turnout=svg.append("g").attr("width",250).attr("height",250).attr("class","turnout toviz").attr("transform","translate(0,0)");
		var g_bjp=svg.append("g").attr("width",250).attr("height",250).attr("class","bjp toviz").attr("transform","translate(250,0)");
		var g_inc=svg.append("g").attr("width",250).attr("height",250).attr("class","inc toviz").attr("transform","translate(500,0)");
		var g_sp=svg.append("g").attr("width",250).attr("height",250).attr("class","sp toviz").attr("transform","translate(750,0)");
		var g_bsp=svg.append("g").attr("width",250).attr("height",250).attr("class","bsp toviz").attr("transform","translate(1000,0)");


		g_turnout.selectAll("path")
		.data(geo_obj.features)
		.enter().append("path")
		.attr("d",path);

		g_bjp.selectAll("path")
		.data(geo_obj.features)
		.enter().append("path")    
		.attr("class",function(d){

			if (d.properties["W_P"+year]=="BJP") return "won";
			else if(d.properties["RU_P"+year]=="BJP") return "runnerup";
			else return "third";
		})
		.attr("d", path);

		g_inc.selectAll("path")
		.data(geo_obj.features)
		.enter().append("path")
		.attr("class",function(d){
			if (d.properties["W_P"+year]=="INC") 
				return "won";
			else if(d.properties["RU_P"+year]=="INC") 
				return "runnerup";
			else 
				return "third";
		})
		.attr("d", path);

		g_sp.selectAll("path")
		.data(geo_obj.features)
		.enter().append("path")
		.attr("class",function(d){
			if (d.properties["W_P"+year]=="SP") return "won";
			else if(d.properties["RU_P"+year]=="SP") return "runnerup";
			else return "third";
		})
		.attr("d", path);

		g_bsp.selectAll("path")
		.data(geo_obj.features)
		.enter().append("path")
		.attr("class",function(d){
			if (d.properties["W_P"+year]=="BSP") return "won";
			else if(d.properties["RU_P"+year]=="BSP") return "runnerup";
			else return "third";
		})
		.attr("d", path);

		g_turnout.selectAll("path")
		.each(function(d,i){
			d3.select(this)
			.transition(t)
			.style("fill",function(d){
				return tout_scale(+d.properties["Turnout"+year]);
			});
		});

		g_bjp.selectAll("path")
		.each(function(d,i){
			d3.select(this)
			.transition(t)
			.style("fill",function(d){
				return (d.properties["W_P"+year]=="BJP")?col_scale(+d.properties["Margin"+year]):"white";
			});
		});

		g_inc.selectAll("path")
		.each(function(d,i){
			d3.select(this)
			.transition(t)
			.style("fill",function(d){
				return (d.properties["W_P"+year]=="INC")?col_scale(+d.properties["Margin"+year]):"white";
			});
		});

		g_sp.selectAll("path")
		.each(function(d,i){
			d3.select(this)
			.transition(t)
			.style("fill",function(d){
				return (d.properties["W_P"+year]=="SP")?col_scale(+d.properties["Margin"+year]):"white";
			});
		});

		g_bsp.selectAll("path")
		.each(function(d,i){
			d3.select(this)
			.transition(t)
			.style("fill",function(d){
				return (d.properties["W_P"+year]=="BSP")?col_scale(+d.properties["Margin"+year]):"white";
			});

		});

	});
}


</script>
